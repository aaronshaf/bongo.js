var bongo;!function(a){var b=function(){function b(b,c){"undefined"==typeof c&&(c=function(){}),this.ensured=!1,this.objectStores=[];var d,e,b,f;if(b.objectStores=b.objectStores||b.collections||[],this.name=b.name,b.objectStores instanceof Array)for(var g=0;g<b.objectStores.length;g++)"string"==typeof b.objectStores[g]&&(b.objectStores[g]={name:b.objectStores[g]}),e=new a.ObjectStore(this,b.objectStores[g]),this[e.name]=e,this.objectStores.push(e);else for(d in b.objectStores)b.objectStores[d]instanceof Array&&(f={},b.objectStores[d].forEach(function(a){f[a]={keyPath:a,multiEntry:!1,unique:!1}}),b.objectStores[d]={name:d,indexes:f}),e=new a.ObjectStore(this,b.objectStores[d]),this[e.name]=e,this.objectStores.push(e);a.supported&&this.ensure(c)}return b.prototype.collection=function(a){return this[a]},b.prototype.objectStore=function(a){return this[a]},b.prototype.signature=function(){var a={};return this.objectStores.forEach(function(b){a[b.name]={autoIncrement:b.autoIncrement,indexes:b.indexes,keyPath:b.keyPath,name:b.name}}),{name:this.name,objectStores:a}},b.prototype.delete=function(b){"undefined"==typeof b&&(b=function(){});for(var c=this,d=0,e=0;e<this.objectStores.length;e++)delete this[this.objectStores[e].name];delete this.objectStores;var f=function(){var e=a.indexedDB.deleteDatabase(c.name);e.onsuccess=function(){b()}.bind(c),e.onblocked=function(){if(!(40>d))throw e.webkitErrorMessage||e.error.name;setTimeout(function(){f(),d++},250)}.bind(c),e.onerror=function(){throw e.webkitErrorMessage||e.error.name}.bind(c)};this.get(function(a){a.close(),f()})},b.prototype.get=function(b){var c=this,d=500,e=function(){if(!c.ensured)return a.debug&&console.log("Database not ensured yet"),d--,d>0&&setTimeout(function(){e()},200),void 0;a.debug&&console.log("Database is ensured");var f=a.indexedDB.open(c.name);f.onupgradeneeded=function(){a.debug&&console.debug("onupgradeneeded"),f.result},f.onsuccess=function(c){a.debug&&console.debug("onsuccess"),b(c.target.result)},f.onblocked=function(){throw console.log(c.version,f),console.log("onblocked"),f.webkitErrorMessage||f.error.name},f.onerror=function(){throw console.log("onerror"),f.webkitErrorMessage||f.error.name},f.onfailure=f.onerror};e()},b.prototype.ensure=function(b){"undefined"==typeof b&&(b=function(){});var c=this;a.debug&&console.debug("Ensuring "+this.name),a.getStoredSignature(this.name,function(d){return a.debug&&console.debug("Signature found: "+JSON.stringify(d)),a.equals(d,c.signature())?(a.getStoredVersion(c.name,function(a){c.version=a,b()}),c.ensured=!0,void 0):(a.getStoredVersion(c.name,function(e){a.debug&&console.debug("Version found: "+e),c.version=e+1;var f=a.indexedDB.open(c.name,c.version);f.onblocked=function(){console.log("blocked",f.error.name)},f.onupgradeneeded=function(e){a.debug&&console.debug("onupgradeneeded in ensure, version "+c.version);for(var g=e.currentTarget.transaction,h=f.result,i=0;i<c.objectStores.length;i++)c.objectStores[i].ensureObjectStore(g,d,h);for(var j in d.objectStores)"undefined"==typeof c[j]&&h.objectStoreNames.contains(j)&&h.deleteObjectStore(j);c.version>2&&h.close(),setTimeout(function(){b()},1),c.ensured=!0}}),void 0)})},b}();a.Database=b}(bongo||(bongo={}));var bongo;!function(a){function b(){var a=Math.floor((new Date).valueOf()/1e3).toString(16);this.key_m||(this.key_m=Math.floor(16777216*Math.random()).toString(16)),this.key_p||(this.key_p=Math.floor(32767*Math.random()).toString(16)),"undefined"==typeof this.key_i?this.key_i=0:this.key_i>16777215&&(this.key_i=0),this.key_i=Number(this.key_i),this.key_i++;var b=this.key_i.toString(16),c="00000000".substr(0,6-a.length)+a+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-b.length)+b;return c}var c=function(){function b(a,b){this.database=a,this.name=b.name,this.keyPath=b.keyPath||"_id",this.autoIncrement=!!b.autoIncrement,this.indexes=b.indexes||{}}return b.prototype.filter=function(b){var c=new a.Query(this.database,[this.name]);return c.filter(b)},b.prototype.find=function(b,c){"undefined"==typeof c&&(c=null);var d=new a.Query(this.database,[this.name]);return d.find(b,c)},b.prototype.findOne=function(b,c){var d=new a.Query(this.database,[this.name]);return d.findOne(b,c)},b.prototype.count=function(a,b){var c=this;"undefined"==typeof b&&"function"==typeof a&&(b=[a,a=null][0]);var d,e=function(a){b(a.target.result)};this.database.get(function(a){var b=a.transaction([c.name],"readonly"),f=b.objectStore(c.name);d=f.count(),d.onsuccess=e}.bind(this))},b.prototype.ensureObjectStore=function(b,c,d){var b,e,f=null;a.debug&&console.debug("ensureObjectStore"),d.objectStoreNames&&d.objectStoreNames.contains(this.name)?d.objectStoreNames&&d.objectStoreNames.contains(this.name)&&(e=b.objectStore(this.name)):(a.debug&&console.debug("Creating "+this.name),e=d.createObjectStore(this.name,{keyPath:"_id",autoIncrement:!1}));for(var g=0;g<e.indexNames.length;g++)"undefined"==typeof this.indexes[e.indexNames.item(g)]&&(console.log("deleting"),e.deleteIndex(e.indexNames.item(g)));for(var f in this.indexes)e.indexNames.contains(f)||e.createIndex(f,this.indexes[f].keyPath);return e},b.prototype.get=function(a,b){"undefined"==typeof a&&(a=""),"undefined"==typeof b&&(b=function(){});var c=this;this.database.get(function(d){var e=d.transaction([c.name],"readonly"),f=e.objectStore(c.name),g=f.get(a);g.onsuccess=function(a){b(a.target.error,a.target.result)}}.bind(this))},b.prototype.remove=function(a,b){"undefined"==typeof b&&(b=function(){});var c=this;this.database.get(function(d){var e,f=d.transaction([c.name],"readwrite"),g=f.objectStore(c.name);"string"==typeof a?e=g.delete(a):"{}"===JSON.stringify(a)&&(e=g.clear()),e.onsuccess=function(a){b(a.target.error,a.target.result)}},!0)},b.prototype.save=function(b,c){"undefined"==typeof c&&(c=function(){});var d=this;b._id||(b._id=a.key()),this.database.get(function(a){var e=a.transaction(d.name,"readwrite"),f=e.objectStore(d.name),g=f.put(b);g.onsuccess=function(a){c(a.target.error,a.target.result)}},!0)},b.prototype.insert=function(b,c){"undefined"==typeof c&&(c=function(){});var d=this;b._id||(b._id=a.key()),this.database.get(function(a){var e=a.transaction([d.name],"readwrite"),f=e.objectStore(d.name),g=f.add(b);g.onerror=function(a){console.log(a.target.error)},g.onsuccess=function(a){c(a.target.error,a.target.result)}},!0)},b.prototype.oldFind=function(b,c){var d=this,e=b.criteria||{},f=b.skip||0;this.database.get(function(g){var h=g.transaction([d.name],"readonly"),i=h.objectStore(d.name),j=[];b.sort&&(j=Object.keys(b.sort));var k=Object.keys(e);"boolean"==typeof e[k[0]]&&(e[k[0]]=e[k[0]]?1:0);var l,m,n,o=[];return 1===k.length&&i.indexNames&&i.indexNames.contains(k[0])?(n=function(a){if(a.target.error)return c(a.target.error);var d=a.target.result;return f>0?f--:d&&o.push(d.value),d&&(!b.limit||o.length<b.limit)?(d["continue"](),void 0):(c(null,o),void 0)},m=i.index(k[0]),l=a.IDBKeyRange.only(e[k[0]]),m.openCursor(l).onsuccess=n,void 0):(n=function(a){if(a.target.error)return c(a.target.error);var d=a.target.result;if(!d)return c(null,o),void 0;if(k.length){var g,h=!0;for(g in k)("undefined"==typeof d.value[k[g]]||d.value[k[g]]!==e[k[g]])&&(h=!1);h&&o.push(d.value)}else f>0?f--:d&&o.push(d.value);return!b.limit||o.length<b.limit?(d["continue"](),void 0):(c(null,o),void 0)},b.sort&&i.indexNames.contains(j[0])?(m=i.index(j[0]),1===b.sort[j[0]]?m.openCursor().onsuccess=n:m.openCursor(null,"prev").onsuccess=n,void 0):(i.openCursor().onsuccess=n,void 0))})},b}();a.ObjectStore=c,a.key=b}(bongo||(bongo={}));var bongo;!function(a){function b(a,b){for(var c={},d=0;d<b.length;d++)b[d]in a&&(c[b[d]]=a[b[d]]);return c}var c=function(){function c(a,b){this.database=a,this.objectStores=b,this._limit=100,this._skip=0,this.from=null,this.to=null,this.before=null,this.after=null,this.filters=[],this.keys=[]}return c.prototype.findOne=function(b,c){return a.supported?(this.find(b).limit(1).toArray(function(a,b){return a?c(a):(b.length?c(a,b[0]):c(a,null),void 0)}),void 0):c("IndexedDB not supported")},c.prototype.find=function(a,b){"undefined"==typeof a&&(a={}),"undefined"==typeof b&&(b=null);var c;if(b&&"object"==typeof b){var d=[];for(c in b)b[c]&&d.push(c);this.pick(d)}return this.filters.push(function(b){var c,d;for(var e in a)if(a[e].constructor===Object)for(c in a[e]){if("$nin"!==c&&"undefined"==typeof b[e])return!1;if("$gt"===c){if(b[e]<=a[e][c])return!1}else if("$gte"===c){if(b[e]<a[e][c])return!1}else if("$lt"===c){if(b[e]>=a[e][c])return!1}else if("$lte"===c){if(b[e]>a[e][c])return!1}else if("$ne"===c){if(b[e]==a[e][c])return!1}else if("$in"===c&&a[e][c]instanceof Array){if(-1===a[e][c].indexOf(b[e]))return!1}else if("$nin"===c&&a[e][c]instanceof Array){if(-1!==a[e][c].indexOf(b[e]))return!1}else{if(!("$all"===c&&b[e]instanceof Array&&a[e][c]instanceof Array))return!1;for(d=0;d<a[e][c].length;d++)if(-1===b[e].indexOf(a[e][c][d]))return!1}}else{if("undefined"==typeof b[e])return!1;if("string"==typeof a[e]){if(b[e]!=a[e])return!1}else if("object"==typeof a[e]&&a[e]instanceof RegExp&&!a[e].test(b[e]))return!1}return!0}),this},c.prototype.filter=function(a){return this.filters.push(a),this},c.prototype.skip=function(a){return this._skip=a,this},c.prototype.limit=function(a){return this._limit=a,this},c.prototype.pick=function(a){return this.keys=a,this},c.prototype.toArray=function(c){var d=this;return a.supported?(this.database.get(function(a){var e=a.transaction(d.objectStores,"readonly"),f=e.objectStore(d.objectStores[0]),g=[],h=function(e){if(e.target.error)return a.close(),c(e.target.error);var f,h,i=e.target.result;if(!i)return a.close(),c(null,g),void 0;if(f=i.value,d.filters.length){h=!0;for(var j=0;j<d.filters.length;j++)d.filters[j](i.value)||(h=!1);h&&(d.keys.length&&(f=b(f,d.keys)),g.push(f))}else d._skip>0?d._skip--:(d.keys.length&&(f=b(f,d.keys)),g.push(f));return g.length<d._limit?(i.continue(),void 0):(a.close(),c(null,g),void 0)};f.openCursor().onsuccess=h}),void 0):c("IndexedDB not supported")},c}();a.Query=c}(bongo||(bongo={}));var bongo;!function(a){function b(b,c){if("undefined"==typeof c&&(c=function(){}),"string"==typeof b){if("undefined"!=typeof a[b])return a[b];b={name:b}}return"undefined"==typeof a[b.name]&&Object.defineProperty(a,b.name,{value:new a.Database(b,c)}),a[b.name]}function c(b,c){"undefined"==typeof c&&(c=function(a){console.log(a)});var d=a.indexedDB.open(b);d.onsuccess=function(a){var b=a.target.result;b.close(),c(b.version)}}function d(b,c){"undefined"==typeof c&&(c=function(a){console.log(a)});var d=a.indexedDB.open(b);d.onblocked=function(a){console.log("blocked",a)},d.onsuccess=function(a){var b,d,e,f=a.target.result,g=[],h={};for(b=0;b<f.objectStoreNames.length;b++)g.push(f.objectStoreNames.item(b));if(!g.length)return f.close(e),c({name:f.name,objectStores:h});var i=f.transaction(g,"readonly");g.forEach(function(a){var b,c=i.objectStore(a);d={};for(var e=0;e<c.indexNames.length;e++)b=c.index(c.indexNames.item(e)),d[c.indexNames.item(e)]={keyPath:b.keyPath,multiEntry:b.multiEntry,unique:b.unique};h[a]={autoIncrement:c.autoIncrement,indexes:d,keyPath:c.keyPath,name:c.name}}),i.oncomplete=function(){return f.close(e),c({name:f.name,objectStores:h})}}}function e(a,b){var c;if(a===b)return!0;for(c in a)if("undefined"==typeof b[c])return!1;for(c in b)if("undefined"==typeof a[c])return!1;if(typeof a!=typeof b)return!1;if("object"!=typeof a)return a===b;for(c in a)if(a[c]){if("object"==typeof a[c]){if(!e(a[c],b[c]))return!1}else if(a[c]!==b[c])return!1}else if(b[c])return!1;return!0}function f(b){"undefined"==typeof b&&(b=null),console.group("Bongo");var c,d=function(b){var c=a.indexedDB.open(b);c.onsuccess=function(a){for(var b=a.target.result,c=[],d=0;d<b.objectStoreNames.length;d++)c.push(b.objectStoreNames.item(d));console.log({name:b.name,objectStores:c,version:b.version})}};b?d(b):a.indexedDB.webkitGetDatabaseNames&&(c=a.indexedDB.webkitGetDatabaseNames(),c.onsuccess=function(a){for(var b=a.target.result,c=0;c<b.length;c++)d(b.item(c))}),console.groupEnd()}a.debug=!1,a.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,a.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,a.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,a.supported=!!a.indexedDB&&!!a.IDBTransaction&&!!a.IDBKeyRange,a.db=b,a.getStoredVersion=c,a.getStoredSignature=d,a.equals=e,a.info=f}(bongo||(bongo={})),"object"==typeof module&&"object"==typeof module.exports?module.exports=bongo:"function"==typeof define&&define.amd&&define("bongo",[],function(){return bongo});