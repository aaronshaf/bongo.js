var bongo;(function(e){var t=function(){function t(t,n){n===void 0&&(n=function(){}),this.ensured=!1,this.objectStores=[],t.objectStores=t.objectStores||t.collections||[],this.name=t.name;for(var o=0;t.objectStores.length>o;o++){"string"==typeof t.objectStores[o]&&(t.objectStores[o]={name:t.objectStores[o]});var r=new e.ObjectStore(this,t.objectStores[o]);this[r.name]=r,this.objectStores.push(r)}e.supported&&this.ensure(n)}return t.prototype.collection=function(e){return this[e]},t.prototype.objectStore=function(e){return this[e]},t.prototype.signature=function(){var e={};return this.objectStores.forEach(function(t){e[t.name]={autoIncrement:t.autoIncrement,indexes:t.indexes,keyPath:t.keyPath,name:t.name}}),{name:this.name,objectStores:e}},t.prototype.delete=function(t){t===void 0&&(t=function(){});for(var n=this,o=0,r=0;this.objectStores.length>r;r++)delete this[this.objectStores[r].name];delete this.objectStores;var i=function(){var r=e.indexedDB.deleteDatabase(n.name);r.onsuccess=function(){t()}.bind(n),r.onblocked=function(){if(!(40>o))throw r.webkitErrorMessage||r.error.name;setTimeout(function(){i(),o++},250)}.bind(n),r.onerror=function(){throw r.webkitErrorMessage||r.error.name}.bind(n)};this.get(function(e){e.close(),i()})},t.prototype.get=function(t){var n=this,o=500,r=function(){if(!n.ensured)return e.debug&&console.log("Database not ensured yet"),o--,o>0&&setTimeout(function(){r()},200),void 0;e.debug&&console.log("Database is ensured");var i=e.indexedDB.open(n.name);i.onupgradeneeded=function(){e.debug&&console.debug("onupgradeneeded");var t=i.result;t.close()},i.onsuccess=function(n){e.debug&&console.debug("onsuccess"),t(n.target.result)},i.onblocked=function(){throw console.log(n.version,i),console.log("onblocked"),i.webkitErrorMessage||i.error.name},i.onerror=function(){throw console.log("onerror"),i.webkitErrorMessage||i.error.name},i.onfailure=i.onerror};r()},t.prototype.ensure=function(t){t===void 0&&(t=function(){});var n=this;e.debug&&console.debug("Ensuring "+this.name),e.getStoredSignature(this.name,function(o){return e.debug&&console.debug("Signature found: "+JSON.stringify(o)),e.equals(o,n.signature())?(e.getStoredVersion(n.name,function(e){n.version=e,t()}),n.ensured=!0,void 0):(e.getStoredVersion(n.name,function(r){e.debug&&console.debug("Version found: "+r),n.version=r+1;var i=e.indexedDB.open(n.name,n.version);i.onblocked=function(){console.log("blocked",i.error.name)},i.onupgradeneeded=function(){e.debug&&console.debug("onupgradeneeded in ensure, version "+n.version);for(var r=i.result,s=0;n.objectStores.length>s;s++)n.objectStores[s].ensureObjectStore(r);for(var a in o.objectStores)n[a]===void 0&&r.objectStoreNames.contains(a)&&r.deleteObjectStore(a);setTimeout(function(){t()},1),n.ensured=!0}}),void 0)})},t}();e.Database=t})(bongo||(bongo={}));var bongo;(function(e){function t(){var e=Math.floor((new Date).valueOf()/1e3).toString(16);this.key_m||(this.key_m=Math.floor(16777216*Math.random()).toString(16)),this.key_p||(this.key_p=Math.floor(32767*Math.random()).toString(16)),this.key_i===void 0?this.key_i=0:this.key_i>16777215&&(this.key_i=0),this.key_i=Number(this.key_i),this.key_i++;var t=this.key_i.toString(16),n="00000000".substr(0,6-e.length)+e+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-t.length)+t;return n}var n=function(){function t(e,t){this.database=e,this.name=t.name,this.keyPath=t.keyPath||"_id",this.autoIncrement=!!t.autoIncrement,this.indexes=t.indexes||[]}return t.prototype.filter=function(t){var n=new e.Query(this.database,[this.name]);return n.filter(t)},t.prototype.find=function(t,n){n===void 0&&(n=null);var o=new e.Query(this.database,[this.name]);return o.find(t,n)},t.prototype.findOne=function(t,n){var o=new e.Query(this.database,[this.name]);return o.findOne(t,n)},t.prototype.count=function(e,t){var n=this;t===void 0&&"function"==typeof e&&(t=[e,e=null][0]);var o,r=function(e){t(e.target.result)};this.database.get(function(e){var t=e.transaction([n.name],"readonly"),i=t.objectStore(n.name);o=i.count(),o.onsuccess=r}.bind(this))},t.prototype.ensureObjectStore=function(t){if(e.debug&&console.debug("ensureObjectStore"),!t.objectStoreNames||!t.objectStoreNames.contains(this.name)){e.debug&&console.debug("Creating "+this.name);var n=t.createObjectStore(this.name,{keyPath:"_id",autoIncrement:!1})}return n},t.prototype.get=function(e,t){e===void 0&&(e=""),t===void 0&&(t=function(){});var n=this;this.database.get(function(o){var r=o.transaction([n.name],"readonly"),i=r.objectStore(n.name),s=i.get(e);s.onsuccess=function(e){t(e.target.error,e.target.result)}}.bind(this))},t.prototype.remove=function(e,t){t===void 0&&(t=function(){});var n=this;this.database.get(function(o){var r,i=o.transaction([n.name],"readwrite"),s=i.objectStore(n.name);"string"==typeof e?r=s.delete(e):"{}"===JSON.stringify(e)&&(r=s.clear()),r.onsuccess=function(e){t(e.target.error,e.target.result)}},!0)},t.prototype.save=function(t,n){n===void 0&&(n=function(){});var o=this;t._id||(t._id=e.key()),this.database.get(function(e){var r=e.transaction(o.name,"readwrite"),i=r.objectStore(o.name),s=i.put(t);s.onsuccess=function(e){n(e.target.error,e.target.result)}},!0)},t.prototype.insert=function(t,n){n===void 0&&(n=function(){});var o=this;t._id||(t._id=e.key()),this.database.get(function(e){var r=e.transaction([o.name],"readwrite"),i=r.objectStore(o.name),s=i.add(t);s.onerror=function(e){console.log(e.target.error)},s.onsuccess=function(e){n(e.target.error,e.target.result)}},!0)},t.prototype.oldFind=function(t,n){var o=this,r=t.criteria||{},i=t.skip||0;this.database.get(function(s){var a=s.transaction([o.name],"readonly"),u=a.objectStore(o.name),c=[];t.sort&&(c=Object.keys(t.sort));var f=Object.keys(r);"boolean"==typeof r[f[0]]&&(r[f[0]]=r[f[0]]?1:0);var d,l,g,h=[];return 1===f.length&&u.indexNames&&u.indexNames.contains(f[0])?(g=function(e){if(e.target.error)return n(e.target.error);var o=e.target.result;return i>0?i--:o&&h.push(o.value),o&&(!t.limit||h.length<t.limit)?(o["continue"](),void 0):(n(null,h),void 0)},l=u.index(f[0]),d=e.IDBKeyRange.only(r[f[0]]),l.openCursor(d).onsuccess=g,void 0):(g=function(e){if(e.target.error)return n(e.target.error);var o=e.target.result;if(!o)return n(null,h),void 0;if(f.length){var s,a=!0;for(s in f)(o.value[f[s]]===void 0||o.value[f[s]]!==r[f[s]])&&(a=!1);a&&h.push(o.value)}else i>0?i--:o&&h.push(o.value);return!t.limit||h.length<t.limit?(o["continue"](),void 0):(n(null,h),void 0)},t.sort&&u.indexNames.contains(c[0])?(l=u.index(c[0]),1===t.sort[c[0]]?l.openCursor().onsuccess=g:l.openCursor(null,"prev").onsuccess=g,void 0):(u.openCursor().onsuccess=g,void 0))})},t}();e.ObjectStore=n,e.key=t})(bongo||(bongo={}));var bongo;(function(e){function t(e,t){for(var n={},o=0;t.length>o;o++)t[o]in e&&(n[t[o]]=e[t[o]]);return n}var n=function(){function n(e,t){this.database=e,this.objectStores=t,this._limit=100,this._skip=0,this.from=null,this.to=null,this.before=null,this.after=null,this.filters=[],this.keys=[]}return n.prototype.findOne=function(t,n){return e.supported?(this.find(t).limit(1).toArray(function(e,t){return e?n(e):(t.length?n(e,t[0]):n(e,null),void 0)}),void 0):n("IndexedDB not supported")},n.prototype.find=function(e,t){e===void 0&&(e={}),t===void 0&&(t=null);var n;if(t&&"object"==typeof t){var o=[];for(n in t)t[n]&&o.push(n);this.pick(o)}return this.filters.push(function(t){var n,o;for(var r in e)if(e[r].constructor===Object)for(n in e[r]){if("$nin"!==n&&t[r]===void 0)return!1;if("$gt"===n){if(t[r]<=e[r][n])return!1}else if("$gte"===n){if(t[r]<e[r][n])return!1}else if("$lt"===n){if(t[r]>=e[r][n])return!1}else if("$lte"===n){if(t[r]>e[r][n])return!1}else if("$ne"===n){if(t[r]==e[r][n])return!1}else if("$in"===n&&e[r][n]instanceof Array){if(-1===e[r][n].indexOf(t[r]))return!1}else if("$nin"===n&&e[r][n]instanceof Array){if(-1!==e[r][n].indexOf(t[r]))return!1}else{if(!("$all"===n&&t[r]instanceof Array&&e[r][n]instanceof Array))return!1;for(o=0;e[r][n].length>o;o++)if(-1===t[r].indexOf(e[r][n][o]))return!1}}else{if(t[r]===void 0)return!1;if("string"==typeof e[r]){if(t[r]!=e[r])return!1}else if("object"==typeof e[r]&&e[r]instanceof RegExp&&!e[r].test(t[r]))return!1}return!0}),this},n.prototype.filter=function(e){return this.filters.push(e),this},n.prototype.skip=function(e){return this._skip=e,this},n.prototype.limit=function(e){return this._limit=e,this},n.prototype.pick=function(e){return this.keys=e,this},n.prototype.toArray=function(n){var o=this;return e.supported?(this.database.get(function(e){var r=e.transaction(o.objectStores,"readonly"),i=r.objectStore(o.objectStores[0]),s=[],a=function(r){if(r.target.error)return e.close(),n(r.target.error);var i,a,u=r.target.result;if(!u)return e.close(),n(null,s),void 0;if(i=u.value,o.filters.length){a=!0;for(var c=0;o.filters.length>c;c++)o.filters[c](u.value)||(a=!1);a&&(o.keys.length&&(i=t(i,o.keys)),s.push(i))}else o._skip>0?o._skip--:(o.keys.length&&(i=t(i,o.keys)),s.push(i));return s.length<o._limit?(u.continue(),void 0):(e.close(),n(null,s),void 0)};i.openCursor().onsuccess=a}),void 0):n("IndexedDB not supported")},n}();e.Query=n})(bongo||(bongo={}));var bongo;(function(e){function t(t,n){if(n===void 0&&(n=function(){}),"string"==typeof t){if(e[t]!==void 0)return e[t];t={name:t}}return e[t.name]===void 0&&Object.defineProperty(e,t.name,{value:new e.Database(t,n)}),e[t.name]}function n(t,n){n===void 0&&(n=function(e){console.log(e)});var o=e.indexedDB.open(t);o.onsuccess=function(e){var t=e.target.result;t.close(),n(t.version)}}function o(t,n){n===void 0&&(n=function(e){console.log(e)});var o=e.indexedDB.open(t);o.onblocked=function(e){console.log("blocked",e)},o.onsuccess=function(e){var t,o,r,i=e.target.result,s=[],a={};for(t=0;i.objectStoreNames.length>t;t++)s.push(i.objectStoreNames.item(t));if(!s.length)return i.close(r),n({name:i.name,objectStores:a});var u=i.transaction(s,"readonly");s.forEach(function(e){var t=u.objectStore(e);o=[];for(var n=0;t.indexNames.length>n;n++)o.push(t.indexNames.item(n));a[e]={autoIncrement:t.autoIncrement,indexes:o,keyPath:t.keyPath,name:t.name}}),u.oncomplete=function(){return i.close(r),n({name:i.name,objectStores:a})}}}function r(e,t){var n;if(e===t)return!0;for(n in e)if(t[n]===void 0)return!1;for(n in t)if(e[n]===void 0)return!1;if(typeof e!=typeof t)return!1;if("object"!=typeof e)return e===t;for(n in e)if(e[n]){if("object"==typeof e[n]){if(!r(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1}else if(t[n])return!1;return!0}function i(t){t===void 0&&(t=null),console.group("Bongo");var n,o=function(t){var n=e.indexedDB.open(t);n.onsuccess=function(e){for(var t=e.target.result,n=[],o=0;t.objectStoreNames.length>o;o++)n.push(t.objectStoreNames.item(o));console.log({name:t.name,objectStores:n,version:t.version})}};t?o(t):e.indexedDB.webkitGetDatabaseNames&&(n=e.indexedDB.webkitGetDatabaseNames(),n.onsuccess=function(e){for(var t=e.target.result,n=0;t.length>n;n++)o(t.item(n))}),console.groupEnd()}e.debug=!1,e.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,e.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,e.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,e.supported=!!e.indexedDB&&!!e.IDBTransaction&&!!e.IDBKeyRange,e.db=t,e.getStoredVersion=n,e.getStoredSignature=o,e.equals=r,e.info=i})(bongo||(bongo={})),"object"==typeof module&&"object"==typeof module.exports?module.exports=bongo:"function"==typeof define&&define.amd&&define("bongo",[],function(){return bongo});